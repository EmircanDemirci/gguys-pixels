<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>GGPixels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #222;
    }

    canvas {
      background: #fff;
      cursor: crosshair;
      display: block;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-900">

  <!-- NAVBAR -->
  <nav class="bg-blue-600 text-white p-4 flex justify-between">
    <div class="font-bold text-lg">GGPixels</div>
    <ul class="flex space-x-6">
      <li><a href="#" onclick="showPage('home')" class="hover:underline">Anasayfa</a></li>
      <li><a href="#" onclick="showPage('canvas')" class="hover:underline">Canvas</a></li>
      <li><a href="#" onclick="showPage('login')" class="hover:underline">Giriş Yap</a></li>
    </ul>
  </nav>

  <!-- SAYFALAR -->
  <main class="p-6">
    <!-- Anasayfa -->
    <section id="home" class="page">
      <h1 class="text-2xl font-bold mb-4">GGPixels'e Hoşgeldin!</h1>
      <p class="mb-4">Gerçek zamanlı piksel yerleştirme oyununa hoşgeldiniz 🎨</p>
      <button onclick="showPage('canvas')" class="px-4 py-2 bg-blue-600 text-white rounded">Canvas'a Git</button>
    </section>

    <!-- Canvas -->
    <section id="canvas" class="page hidden flex justify-center">
      <canvas id="board"></canvas>
    </section>

    <!-- Login -->
    <section id="login" class="page hidden max-w-sm mx-auto">
      <h2 class="text-xl font-bold mb-4">Giriş Yap</h2>
      <form class="space-y-4">
        <div>
          <label class="block">Kullanıcı Adı</label>
          <input type="text" class="w-full border px-3 py-2 rounded" placeholder="Kullanıcı adı">
        </div>
        <div>
          <label class="block">Şifre</label>
          <input type="password" class="w-full border px-3 py-2 rounded" placeholder="Şifre">
        </div>
        <button type="button" class="w-full bg-blue-600 text-white py-2 rounded">Giriş Yap</button>
      </form>
    </section>
  </main>

  <!-- SOCKET.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    function showPage(pageId) {
      document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
      document.getElementById(pageId).classList.remove("hidden");
    }

    // Canvas setup
    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");

    const WIDTH = 500, HEIGHT = 500;   // sunucudaki boyut
    const PIXEL_SIZE = 1;               // her hücre 1x1 piksel
    let scale = 1;                      // zoom için
    let offsetX = 0, offsetY = 0;       // pan için
    let isDragging = false, lastMouseX = 0, lastMouseY = 0;

    // Canvas boyutu board ile aynı
    canvas.width = WIDTH;
    canvas.height = HEIGHT;

    // Canvas datası (başlangıçta boş)
    let board = Array.from({ length: HEIGHT }, () => Array(WIDTH).fill("#FFFFFF"));

    // Sunucudan gelen ilk veri
    socket.on("init", (serverBoard) => {
      board = serverBoard;
      draw();
    });

    // Pixel güncellemesi
    socket.on("updatePixel", ({ x, y, color }) => {
      board[y][x] = color;
      drawPixel(x, y, color);
    });

    // Çizim fonksiyonu (tüm board'u çiz)
    function draw() {
      ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);
      ctx.clearRect(-offsetX / scale, -offsetY / scale, canvas.width / scale, canvas.height / scale);

      for (let y = 0; y < HEIGHT; y++) {
        for (let x = 0; x < WIDTH; x++) {
          ctx.fillStyle = board[y][x];
          ctx.fillRect(x, y, PIXEL_SIZE, PIXEL_SIZE);
        }
      }
    }

    // Tek pixel çiz
    function drawPixel(x, y, color) {
      ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);
      ctx.fillStyle = color;
      ctx.fillRect(x, y, PIXEL_SIZE, PIXEL_SIZE);
    }

    // Canvas tıklama → pixel yerleştirme
    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      const worldX = Math.floor((mouseX - offsetX) / scale);
      const worldY = Math.floor((mouseY - offsetY) / scale);

      if (worldX >= 0 && worldX < WIDTH && worldY >= 0 && worldY < HEIGHT) {
        const color = "#" + Math.floor(Math.random() * 16777215).toString(16);
        socket.emit("placePixel", { x: worldX, y: worldY, color });
      }
    });

    // Zoom (mouse wheel)
    canvas.addEventListener("wheel", (e) => {
      e.preventDefault();
      const zoomFactor = 1.1;

      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Mevcut ölçekte farenin altındaki dünya koordinatı
      const worldX = (mouseX - offsetX) / scale;
      const worldY = (mouseY - offsetY) / scale;

      if (e.deltaY < 0) {
        scale *= zoomFactor; // zoom in
      } else {
        scale /= zoomFactor; // zoom out
      }

      // Scale sınırları
      scale = Math.max(0.2, Math.min(scale, 20));

      // Aynı dünya noktasını farenin altında tut
      offsetX = mouseX - worldX * scale;
      offsetY = mouseY - worldY * scale;

      draw();
    });

    // Pan (drag)
    canvas.addEventListener("mousedown", (e) => {
      isDragging = true;
      lastMouseX = e.clientX;
      lastMouseY = e.clientY;
    });

    canvas.addEventListener("mousemove", (e) => {
      if (isDragging) {
        const dx = e.clientX - lastMouseX;
        const dy = e.clientY - lastMouseY;
        offsetX += dx;
        offsetY += dy;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        draw();
      }
    });

    canvas.addEventListener("mouseup", () => isDragging = false);
    canvas.addEventListener("mouseleave", () => isDragging = false);

    // Artık CSS transform kullanmıyoruz; gerekirse çağrı uyumluluğu için bırakıldı
    function updateTransform() {
      draw();
    }

    // Canvas boyutu board boyutuna göre ayarlandı (yukarıda)
  </script>
</body>

</html>